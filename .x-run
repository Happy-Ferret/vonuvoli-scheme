#!/bin/bash

set -e -E -u -o pipefail -o noclobber -o noglob +o braceexpand || exit -- 1
trap 'printf -- "[ee] failed: %s\n" "${BASH_COMMAND}" >&2' ERR || exit -- 1
test "${#}" -eq 0
export -- LC_ALL=C


cat <<'EOS'

<< compile / peg
	test "${#}" -eq 0
	if test ./sources/parser_peg.peg -nt ./sources/parser_peg.rs ; then
		if test -e ./sources/parser_peg.rs ; then
			rm -- ./sources/parser_peg.rs
		fi
		rust-peg < ./sources/parser_peg.peg >| ./sources/.parser_peg.rs.tmp1
		rust-fmt < ./sources/.parser_peg.rs.tmp1 >| ./sources/.parser_peg.rs.tmp2 && _outcome=0 || _outcome="${?}"
		if test "${_outcome}" -ne 3 ; then
			exit -- "${_outcome}"
		fi
		mv -T -- ./sources/.parser_peg.rs.tmp2 ./sources/parser_peg.rs
		rm -- ./sources/.parser_peg.rs.tmp1
	fi
!!

:: compile / bin / debug :: x-run ':: compile / peg' ; exec -- less-exec env PATH="${RUST_PATH}" cargo build --bin rust-scheme "${@}"
:: compile / bin / release :: x-run ':: compile / peg' ; exec -- less-exec env PATH="${RUST_PATH}" cargo build --bin rust-scheme --release --all-features "${@}"

:: compile / lib / debug :: x-run ':: compile / peg' ; exec -- less-exec env PATH="${RUST_PATH}" cargo build --lib "${@}"
:: compile / lib / release :: x-run ':: compile / peg' ; exec -- less-exec env PATH="${RUST_PATH}" cargo build --lib --release --all-features "${@}"

:: compile / doc / debug :: x-run ':: compile / peg' ; exec -- less-exec env PATH="${RUST_PATH}" cargo doc --all-features "${@}"
:: compile / doc / release :: x-run ':: compile / peg' ; exec -- less-exec env PATH="${RUST_PATH}" cargo doc --release --all-features "${@}"

:: execute / bin / debug :: x-run ':: compile / peg' ; exec -- env PATH="${RUST_PATH}" cargo run -- "${@}"
:: execute / bin / release :: x-run ':: compile / peg' ; exec -- env PATH="${RUST_PATH}" cargo run --release -- "${@}"

:: execute / test / all :: x-run ':: compile / peg' ; exec -- less-exec env PATH="${RUST_PATH}" cargo test --all-features -- "${@}"

:: browse / doc :: exec -- x-www open file://"$( readlink -e -- ./target/doc/rust_scheme/index.html )"

:: clean :: exec -- rm -R -f ./target/

:: grep / sources / x-selection / primary :: exec -- git grep -C10 -F -e "$( exec -- x-selection primary output )" -- ./sources

<< rust-up / initialize
	test "${#}" -eq 0
	if test ! -e ./.rust ; then
		mkdir -- ./.rust
		mkdir -- ./.rust/rustup
		mkdir -- ./.rust/cargo
		curl -s -o ./.rust/rustup-init.tmp -- https://static.rust-lang.org/rustup/dist/x86_64-unknown-linux-gnu/rustup-init
		chmod +x -- ./.rust/rustup-init.tmp
		mv -n -T -- ./.rust/rustup-init.tmp ./.rust/rustup-init
		export -- RUSTUP_HOME="$( exec -- readlink -e -- ./.rust/rustup )"
		export -- CARGO_HOME="$( exec -- readlink -e -- ./.rust/cargo )"
		./.rust/rustup-init -v -y --no-modify-path
	fi
!!

<< rust-up / install
	test "${#}" -eq 0
	test -e ./.rust
	export -- RUSTUP_HOME="$( exec -- readlink -e -- ./.rust/rustup )"
	export -- CARGO_HOME="$( exec -- readlink -e -- ./.rust/cargo )"
	exec -- ./.rust/cargo/bin/rustup install stable
	exec -- ./.rust/cargo/bin/rustup install nightly
!!

<< rust-up / update
	test "${#}" -eq 0
	test -e ./.rust
	export -- RUSTUP_HOME="$( exec -- readlink -e -- ./.rust/rustup )"
	export -- CARGO_HOME="$( exec -- readlink -e -- ./.rust/cargo )"
	exec -- ./.rust/cargo/bin/rustup update
!!

:: rust-up / use / stable :: export -- RUST_PATH="$( exec -- readlink -e -- ./.rust/rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin ):${PATH}"
:: rust-up / use / nightly :: export -- RUST_PATH="$( exec -- readlink -e -- ./.rust/rustup/toolchains/nightly-x86_64-unknown-linux-gnu/bin ):${PATH}"

:: cargo / enable / incremental :: export -- CARGO_INCREMENTAL=1
:: cargo / disable / incremental :: export -- CARGO_INCREMENTAL=0

:: tests / enable / debug :: export -- RUST_SCHEME_TESTS_DEBUG=true
:: tests / disable / debug :: export -- RUST_SCHEME_TESTS_DEBUG=false

EOS


for _test in scheme low-level-r7rs low-level-conversions low-level-parser low-level-sizes ; do
sed -r -e 's#@\{TEST\}#'"${_test}"'#g' <<'EOS'
:: execute / test / @{TEST} :: x-run ':: compile / peg' ; export -- RUST_TEST_TASKS=1 RUST_BACKTRACE=1 ; exec -- env PATH="${RUST_PATH}" cargo test --test @{TEST} --all-features -- --nocapture "${@}"
EOS
done


find . -xdev -type f -name '*.rs' -printf ':: edit / %P :: exec -- sce %p\n' | sort


exit -- 0
